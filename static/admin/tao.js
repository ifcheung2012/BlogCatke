// Generated by CoffeeScript 1.3.3
(function() {

  define(function(require, exports, module) {
    var Modal, Pagination, bind_search, bind_select_commission, bind_select_item, bind_sort, jQuery, list_goods, main, show_goods, show_info, _show_info;
    jQuery = require('bootstrap');
    Modal = require('bootstrap/modal');
    main = jQuery('#select-goods');
    Pagination = require('./pagination');
    _show_info = function(data, box) {
      var comments, content, pop, v, _i, _len, _ref, _ref1;
      if (data.comments && data.info && false === data.is_show) {
        box.find('.load').remove();
        data.is_show = true;
        comments = [];
        _ref1 = (_ref = data.comments) != null ? _ref : [];
        for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
          v = _ref1[_i];
          comments.push("                <div class='comment-box'>                    <div class='user'>                        <img src='" + v.user.avatar + "' alt=''>                        " + v.user.nick + "                    </div>                    <div class='comment'>                        " + v.content + "                    </div>                </div>                ");
        }
        content = "            <div class='item-info'>                <div class='comments'>                    " + (comments.join('')) + "                </div>                <div class='desc'>                    <img class='avatar' src='" + data.pic_url + "' alt=''/>                    <p>                        <strong class='price'>售价：￥" + data.price + "                         / 返佣：￥" + data.commission + " </strong>                    </p>                    <p>                        卖家：" + data.nick + " (" + data.item_location + ")                        &nbsp; / &nbsp;                         信用： " + data.seller_credit_score + " 级                    </p>                </div>                <div class='html'>                    <textarea style='width:720px;'>                    " + data.info.desc + "                    </textarea>                </div>            </div>            ";
        pop = new Modal.Base({
          header: data.title,
          body: content,
          footer: "                <button class='btn btn-primary add-goods'>入库</button>                "
        });
        pop.dom.find('button.add-goods').click(function() {
          pop.remove();
          jQuery.post('/admin/tao-add', {
            data: JSON.stringify(data)
          });
          return false;
        });
        pop.dom.width(1000);
        pop.dom.css({
          marginLeft: -500,
          marginTop: '0',
          top: 10
        }).find('.modal-body').css({
          maxHeight: jQuery(window).height() - 160
        });
        pop.dom.find('textarea').height(jQuery(window).height() - 220);
        pop.show();
        return KindEditor.create(pop.dom.find('textarea'), {
          themeType: 'simple',
          resizeType: 0,
          allowImageUpload: false,
          items: ['fullscreen', 'source', 'preview', '|', 'fontsize', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline', 'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist', 'insertunorderedlist', '|', 'image', 'link']
        });
      }
    };
    show_info = function(data, box) {
      box.append("        <div class='load'>loading...</div>        ");
      data.info = false;
      data.comments = false;
      data.is_show = false;
      jQuery.get('/admin/tao-details', {
        num_iids: data.num_iid
      }, function(json) {
        if (json.success) {
          data.info = json.data[0];
          return _show_info(data, box);
        } else {
          return new Modal.Alert({
            content: json.msg
          });
        }
      });
      return jQuery.get('/admin/tao-comments', {
        num_iid: data.num_iid
      }, function(json) {
        var _ref;
        if (json.success) {
          data.comments = (_ref = json.data.comments) != null ? _ref : [];
          return _show_info(data, box);
        } else {
          data.comments = [];
          return _show_info(data, box);
        }
      });
    };
    list_goods = function(post, data, page) {
      var bind, box, dom, pagination, pagination_dom, pagination_wrap, v, _i, _len, _ref, _results;
      dom = jQuery('#goods-list');
      pagination_wrap = jQuery('.pagination-wrap');
      dom.find('.box').remove();
      pagination_wrap.find('.pagination').remove();
      pagination = new Pagination(data.total_results, page, 40);
      pagination_dom = pagination.render(function(page) {
        return show_goods(post, page);
      });
      pagination_dom.appendTo(pagination_wrap);
      _ref = data.taobaoke_items.taobaoke_item;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        v = _ref[_i];
        box = jQuery("            <div class='box' num_iid='" + v.num_iid + "'>                <img src='" + v.pic_url + "' alt='' >                <div class='commission label label-warning'>返佣：" + (v.commission_rate / 100) + " % = ￥ " + v.commission + "</div>                <span class='price'> ￥ " + v.price + "</span>                <strong title='" + v.title + "'>" + v.title + "</strong>                <hr/>                <span class='badge badge-success'>                    <i class='icon-shopping-cart icon-white'></i>                    " + v.volume + "                </span>                  <a class='btn btn-mini' href='" + v.click_url + "' target='_blank'>                    <i class='icon-map-marker'></i>                </a>                  <a class='btn btn-mini' href='" + v.shop_click_url + "' target='_blank'>                    <i class='icon-home'></i>                </a>                               </div>            ");
        bind = function(data, box) {
          return box.find('img').click(function() {
            show_info(data, box);
            return false;
          });
        };
        bind(v, box);
        _results.push(box.appendTo(dom));
      }
      return _results;
    };
    bind_sort = function() {
      return main.find('.sort-btn .dropdown-menu a').click(function() {
        var that;
        that = jQuery(this);
        main.find('.sort-btn').attr('sort', that.attr('data')).find('button').html(that.html() + ' <span class="caret"></span>');
        return false;
      });
    };
    show_goods = function(data, page) {
      if (page == null) {
        page = 1;
      }
      data.page = page;
      return jQuery.post(data.url, data, function(json) {
        if (json.success) {
          return list_goods(data, json.goods, json.page);
        }
      }, 'json');
    };
    bind_search = function() {
      return main.find('.search-form').submit(function() {
        var data;
        data = {
          keyword: jQuery.trim(main.find('.keyword').val()),
          cid: main.find('.items-btn').attr('cid'),
          sort: main.find('.sort-btn').attr('sort'),
          url: main.find('.search-goods').attr('url'),
          commission_start: main.find('.commission-btn').attr('start'),
          commission_end: main.find('.commission-btn').attr('end')
        };
        show_goods(data);
        return false;
      });
    };
    bind_select_commission = function() {
      var box_dom, btn_dom;
      btn_dom = main.find('.commission-btn');
      box_dom = main.find('.commission-box');
      btn_dom.toggle(function() {
        return box_dom.css('left', btn_dom.position().left).show();
      }, function() {
        return box_dom.hide();
      });
      return box_dom.find('button').click(function() {
        var end, start, that;
        that = jQuery(this);
        start = box_dom.find('.start').val();
        end = box_dom.find('.end').val();
        if (start === '' || end === '') {
          btn_dom.attr('start', 0).attr('end', 0);
          btn_dom.find('span').html("佣金");
        } else {
          btn_dom.attr('start', start).attr('end', end);
          btn_dom.find('span').html("" + start + " ~ " + end + " %");
        }
        return box_dom.hide();
      });
    };
    bind_select_item = function() {
      var search_time;
      main.find('.items-btn').click(function() {
        return main.find('.items-list').slideToggle();
      });
      main.find('.items-list').find('a').click(function() {
        var that;
        that = jQuery(this);
        main.find('.items-btn span').html(that.html());
        main.find('.items-btn').attr('cid', that.attr('cid'));
        main.find('.items-list').slideToggle().find('li').show();
        main.find('.items-list').find('[type=search]').val('');
        return false;
      });
      search_time = false;
      return main.find('.items-list').find('[type=search]').keyup(function() {
        var that;
        that = jQuery(this);
        if (search_time) {
          clearTimeout(search_time);
        }
        return search_time = setTimeout((function() {
          var search;
          search = jQuery.trim(that.val());
          if (search === '') {
            main.find('.items-list').find('li').show();
            return;
          }
          return main.find('.items-list').find('a').each(function() {
            var itemDom;
            itemDom = jQuery(this);
            if (itemDom.text().indexOf(search) !== -1) {
              return itemDom.parent().show();
            } else {
              return itemDom.parent().hide();
            }
          });
        }), 500);
      });
    };
    (function() {
      bind_select_item();
      bind_sort();
      bind_select_commission();
      return bind_search();
    })();
  });

}).call(this);
